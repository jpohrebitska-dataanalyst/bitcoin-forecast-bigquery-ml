# === 1Ô∏è‚É£ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è ===
from google.auth import default
from google.cloud import bigquery
import yfinance as yf
import pandas as pd
from datetime import datetime, timedelta

# –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –≤ Google Cloud
credentials, project_id = default()
client = bigquery.Client(credentials=credentials, project=project_id)
print(f"‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ —è–∫: {project_id}")

# === 2Ô∏è‚É£ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è ===
project_id = "btc-forecast-475211"
table_id = "btc-forecast-475211.btc_data.btc_daily"
log_table_id = "btc-forecast-475211.btc_data.btc_update_log"

# === 3Ô∏è‚É£ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –∑ Yahoo Finance ===
tomorrow = (datetime.today() + timedelta(days=1)).strftime("%Y-%m-%d")
btc = yf.download("BTC-USD", start="2014-01-01", end=tomorrow, progress=False)
btc = btc.reset_index()
btc.columns = btc.columns.map(lambda x: x[0] if isinstance(x, tuple) else x)
btc.columns = [str(c).lower() for c in btc.columns]

btc["snapped_at"] = pd.to_datetime(btc["date"])
btc["price"] = btc["close"]
btc["total_volume"] = btc["volume"]   # volume —Ç—É—Ç —É–∂–µ –≤ –¥–æ–ª–∞—Ä–∞—Ö

# === 4Ô∏è‚É£ –ü–æ—Ç–æ—á–Ω—ñ snapshot-–¥–∞–Ω—ñ –∑ Ticker ===
btc_ticker = yf.Ticker("BTC-USD")
info = btc_ticker.info

market_cap = info.get("marketCap", None)
circulating_supply = info.get("circulatingSupply", None)

# === 5Ô∏è‚É£ –î–æ–¥–∞—î–º–æ –¥–æ DataFrame ===
btc["market_cap"] = market_cap
btc["circulating_supply"] = circulating_supply

df = btc[["snapped_at", "price", "market_cap", "total_volume", "circulating_supply"]]

# === 6Ô∏è‚É£ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤ BigQuery (–ø–µ—Ä–µ–∑–∞–ø–∏—Å —Ç–∞–±–ª–∏—Ü—ñ) ===
job_config = bigquery.LoadJobConfig(write_disposition="WRITE_TRUNCATE")
job = client.load_table_from_dataframe(df, table_id, job_config=job_config)
job.result()

# === 7Ô∏è‚É£ –õ–æ–≥—É–≤–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è ===
log_entry = pd.DataFrame([{
    "update_time": datetime.now(),
    "rows_loaded": len(df),
    "market_cap": market_cap,
    "circulating_supply": circulating_supply,
    "status": "success"
}])

log_job_config = bigquery.LoadJobConfig(write_disposition="WRITE_APPEND")
log_job = client.load_table_from_dataframe(log_entry, log_table_id, job_config=log_job_config)
log_job.result()

# === 8Ô∏è‚É£ –ó–≤—ñ—Ç —É –∫–æ–Ω—Å–æ–ª—ñ ===
print(f"‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ {len(df)} —Ä—è–¥–∫—ñ–≤ —É {table_id}")
print(f"üïí –î–∞—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
print(f"üí∞ –ü–æ—Ç–æ—á–Ω–∞ —Ä–∏–Ω–∫–æ–≤–∞ –∫–∞–ø—ñ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è: {market_cap:,.0f} USD")
print(f"‚öôÔ∏è Circulating supply: {circulating_supply:,.0f} BTC")
